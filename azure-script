# Set the subscription (optional: replace with your subscription ID or name)
$subscriptionId = "your-subscription-id-here"
Set-AzContext -SubscriptionId $subscriptionId

# Get all NICs in the subscription
$allNics = Get-AzNetworkInterface

# Prepare an array to store the results
$allRoutes = @()

# Loop through each NIC
foreach ($nic in $allNics) {
    $nicName = $nic.Name
    $rg = $nic.ResourceGroupName

    Write-Host "Processing NIC: $nicName in RG: $rg" -ForegroundColor Cyan

    try {
        # Get the effective route table for this NIC
        $routeTable = Get-AzEffectiveRouteTable -NetworkInterfaceName $nicName -ResourceGroupName $rg

        # Add each route to the result list with context
        foreach ($route in $routeTable.Value) {
            $allRoutes += [PSCustomObject]@{
                NICName         = $nicName
                ResourceGroup   = $rg
                RouteName       = $route.Name
                State           = $route.State
                Source          = $route.Source
                AddressPrefix   = $route.AddressPrefix -join ", "
                NextHopType     = $route.NextHopType
                NextHopIp       = $route.NextHopIpAddress -join ", "
            }
        }
    } catch {
        Write-Host "❌ Failed to retrieve routes for NIC: $nicName. Error: $_" -ForegroundColor Red
    }
}

# Export to CSV
$outputPath = "AllEffectiveRoutes.csv"
$allRoutes | Export-Csv -Path $outputPath -NoTypeInformation -Encoding UTF8

Write-Host "`n✅ Export completed. File saved as '$outputPath'" -ForegroundColor Green
