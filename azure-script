# Define the subscription ID or Name
$subscriptionId = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"  # <-- Replace with your subscription ID or name

# Connect to Azure (skip this in Azure Cloud Shell)
# Connect-AzAccount

# Set the target subscription
Set-AzContext -SubscriptionId $subscriptionId

# Confirm current context
$currentContext = Get-AzContext
Write-Host "Using Subscription: $($currentContext.Subscription.Name) [$($currentContext.Subscription.Id)]" -ForegroundColor Green

# Get all NICs in the subscription
$allNics = Get-AzNetworkInterface

# Array to hold route data
$allRoutes = @()

# Loop through NICs and get effective route table
foreach ($nic in $allNics) {
    Write-Host "`nFetching routes for NIC: $($nic.Name) in Resource Group: $($nic.ResourceGroupName)" -ForegroundColor Cyan

    try {
        $routes = Get-AzEffectiveRouteTable -NetworkInterfaceName $nic.Name -ResourceGroupName $nic.ResourceGroupName

        foreach ($route in $routes.Value) {
            $allRoutes += [PSCustomObject]@{
                SubscriptionId  = $subscriptionId
                NICName         = $nic.Name
                ResourceGroup   = $nic.ResourceGroupName
                Location        = $nic.Location
                Subnet          = $nic.IpConfigurations[0].Subnet.Id
                RouteName       = $route.Name
                Source          = $route.Source
                State           = $route.State
                AddressPrefix   = $route.AddressPrefix
                NextHopType     = $route.NextHopType
                NextHopIp       = $route.NextHopIpAddress
            }
        }
    } catch {
        Write-Host "❌ Failed to get routes for NIC: $($nic.Name). Error: $_" -ForegroundColor Red
    }
}

# Export all route info to a CSV file
$outputFile = "EffectiveRoutes_$($subscriptionId).csv"
$allRoutes | Export-Csv -Path $outputFile -NoTypeInformation -Encoding UTF8

Write-Host "`n✅ Export complete. File saved as: $outputFile" -ForegroundColor Green
