# OPTIONAL: Login to Azure (Skip this if you're using Azure Cloud Shell)
# Connect-AzAccount

# Get all Network Interfaces (NICs) in the subscription
$allNics = Get-AzNetworkInterface

# Array to store route data
$allRoutes = @()

# Loop through each NIC
foreach ($nic in $allNics) {
    Write-Host "`nFetching routes for NIC: $($nic.Name) in Resource Group: $($nic.ResourceGroupName)" -ForegroundColor Cyan

    try {
        $routes = Get-AzEffectiveRouteTable -NetworkInterfaceName $nic.Name -ResourceGroupName $nic.ResourceGroupName

        # Loop through each route and collect details
        foreach ($route in $routes.Value) {
            $allRoutes += [PSCustomObject]@{
                NICName         = $nic.Name
                ResourceGroup   = $nic.ResourceGroupName
                Location        = $nic.Location
                Subnet          = $nic.IpConfigurations[0].Subnet.Id
                RouteName       = $route.Name
                Source          = $route.Source
                State           = $route.State
                AddressPrefix   = $route.AddressPrefix
                NextHopType     = $route.NextHopType
                NextHopIp       = $route.NextHopIpAddress
            }
        }
    } catch {
        Write-Host "❌ Failed to retrieve routes for NIC: $($nic.Name). Error: $_" -ForegroundColor Red
    }
}

# Export the results to a CSV file
$outputFile = "EffectiveRoutes.csv"
$allRoutes | Export-Csv -Path $outputFile -NoTypeInformation -Encoding UTF8

Write-Host "`n✅ Export complete. File saved as: $outputFile" -ForegroundColor Green
