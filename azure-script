# OPTIONAL: Set the subscription (replace if needed)
$subscriptionId = "xxxxxxxx-xxxx-xxxx-xxxx-xxxxxxxxxxxx"  # Replace with your subscription ID
Set-AzContext -SubscriptionId $subscriptionId

# Get all NICs in the subscription
$allNics = Get-AzNetworkInterface

# List to hold matching NIC names
$matchingNics = @()

foreach ($nic in $allNics) {
    $nicName = $nic.Name
    $resourceGroup = $nic.ResourceGroupName

    try {
        $routeTable = Get-AzEffectiveRouteTable -NetworkInterfaceName $nicName -ResourceGroupName $resourceGroup

        $matchingRoutes = $routeTable.Value | Where-Object {
            $_.State -eq "Active" -and
            $_.Source -eq "Default" -and
            $_.NextHopType -eq "Internet"
        }

        if ($matchingRoutes) {
            Write-Host "‚úÖ Matching NIC found: $nicName" -ForegroundColor Green
            $matchingNics += $nicName
        }
    } catch {
        Write-Host "‚ùå Error checking NIC: $nicName. Error: $_" -ForegroundColor Red
    }
}

# Output final list of NICs
Write-Host "`n=== NICs with Active, Default, Internet Routes ===" -ForegroundColor Cyan
$matchingNics | Sort-Object | ForEach-Object { Write-Host $_ }

# OPTIONAL: Export to CSV
$matchingNics | Sort-Object | Export-Csv -Path "NICsWithInternetRoute.csv" -NoTypeInformation -Encoding UTF8
Write-Host "`nüìÑ Exported matching NICs to NICsWithInternetRoute.csv" -ForegroundColor Yellow
